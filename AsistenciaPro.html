<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Manager Pro v4.2</title>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #34495e;
            --accent: #3498db;
            --danger: #e74c3c;
            --warning: #f39c12;
            --success: #27ae60;
            --light: #ecf0f1;
            --dark: #7f8c8d;
        }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background-color: #eef2f3; color: #333; }
        
        /* Layout General */
        .container { max-width: 1100px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); min-height: 80vh; }
        
        /* HEADER */
        header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--light); padding-bottom: 15px; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        h1 { margin: 0; color: var(--primary); font-size: 1.8em; }
        .subtitle { color: var(--dark); font-size: 0.9em; margin-top: 5px; }
        
        .header-buttons { display: flex; gap: 10px; }

        /* VISTAS */
        .view-section { display: none; animation: fadeIn 0.3s; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- DASHBOARD (CURSOS) --- */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; margin-top: 20px; }
        
        .course-card { background: white; border: 1px solid #ddd; border-radius: 8px; padding: 20px; transition: 0.2s; position: relative; border-left: 5px solid var(--accent); box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; }
        .course-card:hover { transform: translateY(-3px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); }
        .course-card h3 { margin: 0 0 10px 0; color: var(--primary); }
        .course-card p { margin: 0; color: var(--dark); font-size: 0.9em; }
        
        .course-actions { margin-top: 15px; display: flex; justify-content: flex-end; gap: 10px; border-top: 1px solid #eee; padding-top: 10px; }
        .btn-icon { background: none; border: none; cursor: pointer; font-size: 1.2em; padding: 5px; border-radius: 4px; transition: 0.2s; }
        .btn-icon:hover { background-color: #f0f0f0; transform: scale(1.1); }
        .btn-icon.delete { color: var(--danger); }
        .btn-icon.edit { color: var(--accent); }

        /* Tarjeta especial para A√±adir */
        .add-course-card { border: 2px dashed #bbb; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #888; border-left: 2px dashed #bbb; min-height: 150px; background-color: #fafafa; }
        .add-course-card:hover { border-color: var(--accent); color: var(--accent); background: #f0f8ff; }
        .add-icon { font-size: 3em; margin-bottom: 10px; font-weight: bold; }

        /* --- VISTA CURSO (ASISTENCIA) --- */
        .nav-back { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; cursor: pointer; color: var(--secondary); font-weight: bold; padding: 10px; background: #f8f9fa; border-radius: 5px; width: fit-content; }
        .nav-back:hover { background: #e9ecef; color: var(--primary); }

        .tabs { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; border-bottom: 1px solid #eee; }
        .tab-btn { padding: 10px 20px; border: none; background: transparent; cursor: pointer; font-weight: bold; color: var(--dark); border-bottom: 3px solid transparent; transition: 0.3s; }
        .tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Tablas y Controles */
        .date-control { background: #e8f6f3; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; align-items: center; gap: 15px; border-left: 5px solid var(--success); }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #eee; }
        th { background-color: #f8f9fa; color: var(--secondary); }
        tr:hover { background-color: #fafafa; }
        
        /* Botones Acci√≥n Asistencia */
        .action-grid { display: flex; gap: 5px; flex-wrap: wrap; }
        .act-btn { padding: 8px; font-size: 12px; cursor: pointer; border: 1px solid #ddd; background: white; border-radius: 4px; flex: 1; min-width: 60px; font-weight: 600; transition: 0.2s; }
        .act-btn:hover { transform: scale(1.05); }
        
        .act-presente { color: var(--success); border-color: var(--success); }
        .act-presente.active { background: var(--success); color: white; }
        
        .act-retardo { color: var(--warning); border-color: var(--warning); }
        .act-retardo.active { background: var(--warning); color: white; }
        
        .act-injust { color: var(--danger); border-color: var(--danger); }
        .act-injust.active { background: var(--danger); color: white; }
        
        .act-fuga { color: var(--primary); border-color: var(--primary); }
        .act-fuga.active { background: var(--primary); color: white; }
        
        .act-just { color: var(--accent); border-color: var(--accent); }
        .act-just.active { background: var(--accent); color: white; }

        /* Clases utilitarias */
        .score-bad { color: var(--danger); font-weight: bold; }
        .score-good { color: var(--success); font-weight: bold; }
        .clickable-name { color: var(--accent); cursor: pointer; text-decoration: underline; font-weight: bold; }
        
        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; color: white; font-weight: bold; }
        .btn-add { background: var(--success); }
        .btn-danger { background: var(--danger); }
        .btn-primary { background: var(--primary); }
        .btn-restore { background: var(--secondary); }
        input, textarea { padding: 10px; border: 1px solid #ddd; border-radius: 4px; width: 100%; box-sizing: border-box; }

        /* MODALES */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 2000; backdrop-filter: blur(2px); }
        .modal-content { background: white; padding: 25px; border-radius: 10px; width: 90%; max-width: 450px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); animation: fadeIn 0.2s; }
        .modal-header { display: flex; justify-content: space-between; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .close-x { cursor: pointer; font-size: 1.5em; font-weight: bold; color: #999; }
        .close-x:hover { color: #333; }

        .history-item { padding: 8px 0; border-bottom: 1px dashed #eee; font-size: 0.9em; display: flex; justify-content: space-between; }

    </style>
</head>
<body>

<div class="container">
    
    <div id="view-dashboard" class="view-section active">
        <header>
            <div>
                <h1>üè´ Panel de Cursos</h1>
                <div class="subtitle">Gestiona m√∫ltiples salones desde un solo lugar</div>
            </div>
            
            <div class="header-buttons">
                <button class="btn btn-restore" onclick="document.getElementById('globalRestore').click()">üìÇ Restaurar</button>
                <button class="btn btn-danger" onclick="Manager.descargarBackupGlobal()">üíæ Backup Completo</button>
                
                <input type="file" id="globalRestore" style="display:none" onchange="Manager.restaurarGlobal(this)">
            </div>
        </header>

        <div id="courses-list" class="dashboard-grid">
            </div>
    </div>

    <div id="view-course" class="view-section">
        <div class="nav-back" onclick="Manager.irAlDashboard()">
            <span>‚¨Ö Volver al Panel Principal</span>
        </div>

        <header>
            <h1 id="course-title-display">Curso: --</h1>
            <div class="header-buttons">
                <button class="btn btn-primary" onclick="App.descargarBackup()">üíæ Backup (Solo este sal√≥n)</button>
            </div>
        </header>

        <div class="tabs">
            <button class="tab-btn active" onclick="App.cambiarTab('tab-asistencia')">üìù Asistencia</button>
            <button class="tab-btn" onclick="App.cambiarTab('tab-estudiantes')">üë• Estudiantes</button>
            <button class="tab-btn" onclick="App.cambiarTab('tab-reporte')">‚ö†Ô∏è Reporte (< 80)</button>
        </div>

        <div id="tab-asistencia" class="tab-content active">
            <div class="date-control">
                <label>üìÖ Fecha:</label>
                <input type="date" id="fechaSeleccionada" onchange="App.renderizar()">
            </div>
            <table id="tablaAsistencia">
                <thead>
                    <tr>
                        <th width="35%">Estudiante</th>
                        <th width="10%">Puntos</th>
                        <th>Acci√≥n (Click para marcar)</th>
                    </tr>
                </thead>
                <tbody id="listaAsistencia"></tbody>
            </table>
        </div>

        <div id="tab-estudiantes" class="tab-content">
            <div style="display:flex; gap:10px; margin-bottom:20px">
                <input type="text" id="nuevoEstudianteNombre" placeholder="Nombre completo...">
                <button class="btn btn-add" onclick="App.agregarEstudiante()">+ A√±adir</button>
            </div>
            <table id="tablaGestion">
                <thead><tr><th>Nombre</th><th>Puntos</th><th>Acciones</th></tr></thead>
                <tbody id="listaGestion"></tbody>
            </table>
        </div>

        <div id="tab-reporte" class="tab-content">
            <h3 style="color:var(--danger)">Estudiantes en riesgo acad√©mico</h3>
            <table id="tablaRiesgo">
                <thead><tr><th>Nombre</th><th>Puntos</th><th>√öltimas Incidencias</th></tr></thead>
                <tbody id="listaRiesgo"></tbody>
            </table>
        </div>
    </div>

</div>

<div id="modalCurso" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Gestionar Curso</h3>
            <span class="close-x" onclick="Manager.cerrarModalCurso()">&times;</span>
        </div>
        
        <input type="hidden" id="editCourseId">
        
        <label><strong>Nombre del Curso (Ej: 7A):</strong></label>
        <input type="text" id="courseNameInput" placeholder="Escribe aqu√≠..." style="margin-bottom:15px; margin-top:5px;">
        
        <label><strong>Descripci√≥n (Opcional):</strong></label>
        <input type="text" id="courseDescInput" placeholder="Ej: Clase de la ma√±ana" style="margin-bottom:20px; margin-top:5px;">
        
        <button class="btn btn-primary" style="width:100%" onclick="Manager.guardarCurso()">Guardar y Crear</button>
    </div>
</div>

<div id="modalJustificacion" class="modal">
    <div class="modal-content">
        <div class="modal-header"><h3>Justificar</h3><span class="close-x" onclick="App.cerrarModal('modalJustificacion')">&times;</span></div>
        <p id="justifInfo" style="margin-bottom:10px; font-weight:bold; color:var(--accent)"></p>
        <textarea id="justifMotivo" rows="2" placeholder="Motivo de la excusa..."></textarea>
        <input type="text" id="justifEnvia" placeholder="¬øQui√©n env√≠a la excusa?" style="margin-top:10px">
        <br><br>
        <button class="btn btn-add" style="width:100%" onclick="App.guardarJustificacion()">Guardar</button>
    </div>
</div>

<div id="modalDetalle" class="modal">
    <div class="modal-content">
        <div class="modal-header"><h3 id="detalleNombre"></h3><span class="close-x" onclick="App.cerrarModal('modalDetalle')">&times;</span></div>
        <div id="detalleHistorial" style="max-height:300px; overflow-y:auto"></div>
    </div>
</div>

<script>
/**
 * MANAGER: Gestiona la lista de cursos
 */
const Manager = {
    cursos: [],
    
    init: function() {
        const saved = localStorage.getItem('teacher_app_courses');
        if(saved) {
            this.cursos = JSON.parse(saved);
        } else {
            // Migraci√≥n de emergencia V3 -> V4
            const oldData = localStorage.getItem('data_curso_7a_v3');
            if(oldData) {
                const id = Date.now().toString();
                this.cursos.push({ id: id, name: "7A (Recuperado)", desc: "Importado autom√°ticamente" });
                localStorage.setItem(`teacher_data_${id}`, oldData);
                this.saveCourses();
            }
        }
        this.renderDashboard();
    },

    saveCourses: function() {
        localStorage.setItem('teacher_app_courses', JSON.stringify(this.cursos));
    },

    renderDashboard: function() {
        const grid = document.getElementById('courses-list');
        grid.innerHTML = '';
        
        // 1. Renderizar cursos existentes
        this.cursos.forEach(c => {
            const card = `
            <div class="course-card" onclick="Manager.entrarCurso('${c.id}')">
                <h3>${c.name}</h3>
                <p>${c.desc}</p>
                <div class="course-actions">
                    <button class="btn-icon edit" onclick="Manager.editarCurso(event, '${c.id}')" title="Editar">‚úèÔ∏è</button>
                    <button class="btn-icon delete" onclick="Manager.borrarCurso(event, '${c.id}')" title="Borrar">üóëÔ∏è</button>
                </div>
            </div>`;
            grid.innerHTML += card;
        });

        // 2. Renderizar bot√≥n de crear
        const addCard = `
        <div class="course-card add-course-card" onclick="Manager.abrirModalCurso()">
            <div class="add-icon">+</div>
            <h3>Crear Nuevo Curso</h3>
        </div>`;
        grid.innerHTML += addCard;
    },

    abrirModalCurso: function() {
        document.getElementById('editCourseId').value = "";
        document.getElementById('courseNameInput').value = "";
        document.getElementById('courseDescInput').value = "";
        document.getElementById('modalCurso').style.display = 'flex';
        setTimeout(() => document.getElementById('courseNameInput').focus(), 100);
    },

    cerrarModalCurso: function() {
        document.getElementById('modalCurso').style.display = 'none';
    },

    guardarCurso: function() {
        const id = document.getElementById('editCourseId').value;
        const name = document.getElementById('courseNameInput').value.trim();
        const desc = document.getElementById('courseDescInput').value.trim();
        
        if(!name) return alert("Por favor, escribe un nombre para el curso.");

        if(id) {
            // Editar
            const c = this.cursos.find(x => x.id === id);
            if(c) { c.name = name; c.desc = desc; }
        } else {
            // Crear nuevo
            const newId = Date.now().toString();
            this.cursos.push({ id: newId, name: name, desc: desc });
            localStorage.setItem(`teacher_data_${newId}`, JSON.stringify([]));
        }
        
        this.saveCourses();
        this.cerrarModalCurso();
        this.renderDashboard();
    },

    editarCurso: function(e, id) {
        e.stopPropagation();
        const c = this.cursos.find(x => x.id === id);
        document.getElementById('editCourseId').value = id;
        document.getElementById('courseNameInput').value = c.name;
        document.getElementById('courseDescInput').value = c.desc;
        document.getElementById('modalCurso').style.display = 'flex';
    },

    borrarCurso: function(e, id) {
        e.stopPropagation();
        if(!confirm("¬øEST√ÅS SEGURO?\n\nSe borrar√° el curso y TODOS los datos de asistencia asociados. No se puede deshacer.")) return;
        
        this.cursos = this.cursos.filter(x => x.id !== id);
        this.saveCourses();
        localStorage.removeItem(`teacher_data_${id}`);
        this.renderDashboard();
    },

    entrarCurso: function(id) {
        const c = this.cursos.find(x => x.id === id);
        if(!c) return;
        App.loadCourse(id, c.name);
        document.getElementById('view-dashboard').classList.remove('active');
        document.getElementById('view-course').classList.add('active');
    },

    irAlDashboard: function() {
        document.getElementById('view-course').classList.remove('active');
        document.getElementById('view-dashboard').classList.add('active');
        App.currentCourseId = null;
    },

    // --- NUEVO: SISTEMA DE BACKUP GLOBAL ---
    descargarBackupGlobal: function() {
        // Empaquetar TODOS los datos
        const paqueteGlobal = {
            tipo: "FULL_SYSTEM_BACKUP",
            fecha: new Date().toISOString(),
            listaCursos: this.cursos,
            datosCursos: {}
        };

        // Recorrer cada curso y sacar sus datos
        this.cursos.forEach(c => {
            const key = `teacher_data_${c.id}`;
            const datos = JSON.parse(localStorage.getItem(key) || '[]');
            paqueteGlobal.datosCursos[key] = datos;
        });

        // Descargar
        const str = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(paqueteGlobal));
        const a = document.createElement('a');
        a.href = str;
        a.download = `Respaldo_COMPLETO_TeacherManager_${new Date().toISOString().split('T')[0]}.json`;
        a.click();
    },

    restaurarGlobal: function(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        
        reader.onload = (e) => {
            try {
                const backup = JSON.parse(e.target.result);
                
                // Caso 1: Es un backup GLOBAL (el nuevo)
                if(backup.tipo === "FULL_SYSTEM_BACKUP") {
                    if(!confirm(`‚ö†Ô∏è ATENCI√ìN ‚ö†Ô∏è\n\nEst√°s a punto de restaurar un RESPALDO COMPLETO.\nEsto reemplazar√° TODOS los cursos actuales con los del archivo.\n\n¬øEst√°s seguro?`)) return;

                    // 1. Restaurar lista de cursos
                    this.cursos = backup.listaCursos;
                    this.saveCourses();

                    // 2. Restaurar datos de cada curso
                    for (const [key, value] of Object.entries(backup.datosCursos)) {
                        localStorage.setItem(key, JSON.stringify(value));
                    }

                    alert("¬°Sistema completo restaurado con √©xito!");
                    this.renderDashboard();

                // Caso 2: Es un backup INDIVIDUAL (el antiguo)
                } else if (backup.meta && backup.data) {
                    if(!confirm(`Este archivo parece ser el respaldo de UN SOLO CURSO ("${backup.meta.name}").\n\n¬øDeseas importarlo como un curso nuevo?`)) return;
                    
                    const newId = Date.now().toString();
                    this.cursos.push({ id: newId, name: backup.meta.name + " (Imp)", desc: backup.meta.desc });
                    this.saveCourses();
                    localStorage.setItem(`teacher_data_${newId}`, JSON.stringify(backup.data));
                    
                    alert("Curso importado correctamente.");
                    this.renderDashboard();

                } else {
                    throw new Error("Formato desconocido");
                }

            } catch(err) {
                alert("Error: El archivo no es v√°lido o est√° da√±ado.");
                console.error(err);
            }
            input.value = "";
        };
        reader.readAsText(file);
    }
};

/**
 * APP: Gestiona la l√≥gica dentro de un curso
 */
const App = {
    currentCourseId: null,
    currentCourseName: "",
    estudiantes: [],
    tempId: null,

    loadCourse: function(id, name) {
        this.currentCourseId = id;
        this.currentCourseName = name;
        document.getElementById('course-title-display').innerText = `Curso: ${name}`;
        
        const data = localStorage.getItem(`teacher_data_${id}`);
        this.estudiantes = data ? JSON.parse(data) : [];
        
        document.getElementById('fechaSeleccionada').value = new Date().toISOString().split('T')[0];
        this.renderizar();
    },

    saveData: function() {
        if(!this.currentCourseId) return;
        localStorage.setItem(`teacher_data_${this.currentCourseId}`, JSON.stringify(this.estudiantes));
        this.renderizar();
    },

    cambiarTab: function(tabId) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        
        const btns = document.querySelectorAll('.tab-btn');
        if(tabId === 'tab-asistencia') btns[0].classList.add('active');
        if(tabId === 'tab-estudiantes') btns[1].classList.add('active');
        if(tabId === 'tab-reporte') btns[2].classList.add('active');
    },

    agregarEstudiante: function() {
        const input = document.getElementById('nuevoEstudianteNombre');
        const nombre = input.value.trim();
        if(!nombre) return alert("Escribe un nombre");
        
        this.estudiantes.push({
            id: Date.now(),
            nombre: nombre,
            puntos: 100,
            historial: []
        });
        input.value = "";
        this.saveData();
    },

    registrar: function(studentId, tipo) {
        const fecha = document.getElementById('fechaSeleccionada').value;
        if(!fecha) return alert("Selecciona fecha");
        
        const est = this.estudiantes.find(e => e.id === studentId);
        
        // 1. Correcci√≥n mismo d√≠a
        const idx = est.historial.findIndex(h => h.fecha === fecha && h.tipo !== 'bonus');
        if(idx !== -1) {
            const prev = est.historial[idx];
            if(prev.tipo === tipo) return;
            // Revertir
            est.puntos += prev.puntosPerdidos;
            if(est.puntos > 100) est.puntos = 100;
            est.historial.splice(idx, 1);
        }

        // 2. Justificaci√≥n
        if(tipo === 'justificada') {
            this.tempId = studentId;
            document.getElementById('justifInfo').innerText = `${est.nombre} - ${fecha}`;
            document.getElementById('modalJustificacion').style.display = 'flex';
            return;
        }

        let pts = 0; let det = "";
        if(tipo === 'retardo') { pts = 3; det = "Retardo"; }
        if(tipo === 'injustificada') { pts = 5; det = "Falta Injustificada"; }
        if(tipo === 'fuga') { pts = 10; det = "Fuga"; }
        if(tipo === 'presente') { det = "Asiste"; }

        this.aplicar(est, tipo, pts, det, fecha);
        if(tipo === 'presente') this.checkRacha(est);
    },

    aplicar: function(est, tipo, pts, det, fecha) {
        est.puntos -= pts;
        if(est.puntos > 100) est.puntos = 100;
        est.historial.unshift({ id: Date.now(), fecha, tipo, detalle: det, puntosPerdidos: pts });
        this.saveData();
    },

    guardarJustificacion: function() {
        const mot = document.getElementById('justifMotivo').value;
        const env = document.getElementById('justifEnvia').value;
        if(!mot) return;
        const est = this.estudiantes.find(e => e.id === this.tempId);
        const fecha = document.getElementById('fechaSeleccionada').value;
        this.aplicar(est, 'justificada', 0, `Excusa: ${mot} (${env})`, fecha);
        document.getElementById('justifMotivo').value = "";
        document.getElementById('justifEnvia').value = "";
        this.cerrarModal('modalJustificacion');
    },

    checkRacha: function(est) {
        const evs = est.historial.filter(h => ['presente','retardo','injustificada','fuga','justificada'].includes(h.tipo));
        let c = 0;
        for(let e of evs) { if(e.tipo === 'presente') c++; else break; }
        
        if(c > 0 && c % 10 === 0) {
            const hoy = new Date().toISOString().split('T')[0];
            const ya = est.historial.some(h => h.tipo === 'bonus' && h.fecha === hoy);
            if(!ya) {
                est.puntos += 2; if(est.puntos > 100) est.puntos = 100;
                est.historial.unshift({ id: Date.now(), fecha: hoy, tipo: 'bonus', detalle: 'Racha 10 asistencias', puntosPerdidos: -2 });
                alert(`¬°Racha! ${est.nombre} gana 2 puntos.`);
                this.saveData();
            }
        }
    },

    renderizar: function() {
        const fecha = document.getElementById('fechaSeleccionada').value;
        const tbAsis = document.getElementById('listaAsistencia');
        tbAsis.innerHTML = "";
        
        [...this.estudiantes].sort((a,b)=>a.nombre.localeCompare(b.nombre)).forEach(est => {
            const hoy = est.historial.find(h => h.fecha === fecha && h.tipo !== 'bonus');
            const st = hoy ? hoy.tipo : '';
            
            tbAsis.innerHTML += `<tr>
                <td><span class="clickable-name" onclick="App.verDetalle(${est.id})">${est.nombre}</span></td>
                <td><strong class="${est.puntos < 80 ? 'score-bad':'score-good'}">${est.puntos}</strong></td>
                <td><div class="action-grid">
                    <button class="act-btn act-presente ${st==='presente'?'active':''}" onclick="App.registrar(${est.id},'presente')">Presente</button>
                    <button class="act-btn act-retardo ${st==='retardo'?'active':''}" onclick="App.registrar(${est.id},'retardo')">Retardo</button>
                    <button class="act-btn act-just ${st==='justificada'?'active':''}" onclick="App.registrar(${est.id},'justificada')">Excusa</button>
                    <button class="act-btn act-injust ${st==='injustificada'?'active':''}" onclick="App.registrar(${est.id},'injustificada')">Falta</button>
                    <button class="act-btn act-fuga ${st==='fuga'?'active':''}" onclick="App.registrar(${est.id},'fuga')">Fuga</button>
                </div></td>
            </tr>`;
        });

        const tbGest = document.getElementById('listaGestion');
        tbGest.innerHTML = "";
        this.estudiantes.forEach(est => {
            tbGest.innerHTML += `<tr><td>${est.nombre}</td><td>${est.puntos}</td>
            <td><button class="btn btn-danger" style="padding:5px" onclick="App.eliminarEstudiante(${est.id})">Borrar</button></td></tr>`;
        });

        const tbRep = document.getElementById('listaRiesgo');
        tbRep.innerHTML = "";
        this.estudiantes.filter(e => e.puntos < 80).forEach(est => {
            const l = est.historial.filter(h => h.puntosPerdidos > 0).slice(0,3).map(h=>`${h.fecha}: ${h.detalle}`).join('<br>');
            tbRep.innerHTML += `<tr><td>${est.nombre}</td><td class="score-bad">${est.puntos}</td><td><small>${l}</small></td></tr>`;
        });
    },

    eliminarEstudiante: function(id) {
        if(confirm("¬øBorrar estudiante?")) {
            this.estudiantes = this.estudiantes.filter(e => e.id !== id);
            this.saveData();
        }
    },

    verDetalle: function(id) {
        const est = this.estudiantes.find(e => e.id === id);
        document.getElementById('detalleNombre').innerText = est.nombre;
        const d = document.getElementById('detalleHistorial');
        d.innerHTML = "";
        est.historial.forEach(h => {
            d.innerHTML += `<div class="history-item">
                <span><b>${h.fecha}</b> ${h.detalle}</span>
                <span>${h.puntosPerdidos>0?'-'+h.puntosPerdidos:'+'+Math.abs(h.puntosPerdidos)} 
                <a href="#" style="color:red;margin-left:5px" onclick="App.borrarH(${est.id},${h.id})">x</a></span>
            </div>`;
        });
        document.getElementById('modalDetalle').style.display = 'flex';
    },

    borrarH: function(sid, hid) {
        if(!confirm("¬øBorrar evento?")) return;
        const est = this.estudiantes.find(e => e.id === sid);
        const idx = est.historial.findIndex(h => h.id === hid);
        if(idx !== -1) {
            est.puntos += est.historial[idx].puntosPerdidos;
            if(est.puntos > 100) est.puntos = 100;
            est.historial.splice(idx, 1);
            this.saveData();
            this.verDetalle(sid);
        }
    },

    cerrarModal: function(id) { document.getElementById(id).style.display = 'none'; },
    
    descargarBackup: function() {
        const p = { meta: { name: this.currentCourseName, desc: "Backup" }, data: this.estudiantes };
        const s = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(p));
        const a = document.createElement('a'); a.href = s; a.download = `Backup_${this.currentCourseName}.json`;
        a.click();
    }
};

// Start
document.addEventListener('DOMContentLoaded', () => Manager.init());

</script>
</body>
</html>