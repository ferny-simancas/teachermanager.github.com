<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor Acad√©mico Ingl√©s v2.6</title>
    <style>
        :root { 
            --primary: #2c3e50; 
            --danger: #e74c3c; 
            --success: #27ae60; 
            --bg: #f0f2f5;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .container { max-width: 1400px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .header { text-align: center; border-bottom: 3px solid var(--primary); margin-bottom: 25px; padding-bottom: 10px; }
        .section { background: #fff; border: 1px solid #e1e4e8; padding: 20px; border-radius: 8px; margin-bottom: 25px; }
        
        .table-container { overflow-x: auto; margin-top: 15px; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th, td { border: 1px solid #dfe4e8; padding: 10px; text-align: center; }
        th { background: var(--primary); color: white; font-size: 0.85em; position: relative; }
        
        .col-estudiante { text-align: left; min-width: 220px; font-weight: bold; background: #f8f9fa; }
        
        input[type="number"] { width: 65px; padding: 6px; border-radius: 4px; border: 1px solid #ccc; text-align: center; }
        input.low { background: #ffdce0 !important; color: var(--danger) !important; font-weight: bold; border-color: var(--danger); }
        .final-cell { background: #f1f3f5; font-weight: bold; width: 80px; }
        .low-grade { color: var(--danger) !important; background: #ffdce0 !important; }
        .examen-bimestral { background: #fff8e1; border: 1px solid #ffca28 !important; }

        .btn { padding: 10px 18px; border: none; border-radius: 6px; cursor: pointer; color: white; font-weight: 600; }
        .btn-add { background: var(--success); }
        .btn-action { background: var(--primary); }
        .btn-delete { background: var(--danger); }
        .btn-small-del { background: var(--danger); padding: 4px 8px; font-size: 0.75em; border-radius: 4px; color:white; border:none; cursor:pointer;}
        .btn-del-task { background: rgba(255,255,255,0.3); border-radius: 50%; color: white; border: none; cursor: pointer; width: 20px; height: 20px; position: absolute; top: 2px; right: 2px; }
        
        .flex-row { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; margin-bottom: 15px; }
        .indicador-block { border-top: 4px solid var(--primary); padding-top: 15px; margin-top: 30px; }
        .resumen-bajas { background: #fff5f5; border: 1px solid #feb2b2; padding: 20px; border-radius: 8px; }
        .citacion-box { background: #eef2f7; border: 1px solid #d1d9e6; padding: 20px; border-radius: 8px; margin-top: 20px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1 id="txtCurso">Cargando...</h1>
        <h2 id="txtPeriodo">Periodo</h2>
    </div>

    <div class="section">
        <div class="flex-row">
            <input type="text" id="inNuevoCurso" placeholder="Nombre del curso">
            <button class="btn btn-add" onclick="crearCurso()">+ Crear Curso</button>
            <select id="selCurso" onchange="seleccionarCurso()"></select>
            <button id="btnEliminarCurso" class="btn btn-delete" style="display:none" onclick="eliminarCurso()">Eliminar Curso</button>
            <select id="selPeriodo" onchange="seleccionarPeriodo()">
                <option value="1">Periodo 1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option>
            </select>
        </div>
        <div class="flex-row" id="areaAlumnos" style="display:none">
            <input type="text" id="inAlumno" placeholder="Nombre del estudiante">
            <button class="btn btn-action" onclick="a√±adirAlumno()">A√±adir Estudiante</button>
        </div>
    </div>

    <div id="mainCalificaciones"></div>

    <div class="section resumen-bajas" id="seccionAlertas" style="display:none">
        <h3>üö® Estudiantes con Dificultades (< 75)</h3>
        <div id="listaDificultades"></div>
    </div>

    <div class="section citacion-box" id="seccionCitaciones" style="display:none">
        <h3>‚úâÔ∏è Preparar Citaci√≥n de Padres</h3>
        <div class="flex-row">
            <select id="selAlumnoCitacion"></select>
            <input type="text" id="nombreAcudiente" placeholder="Acudiente">
            <button class="btn btn-action" onclick="generarCitacion()">Generar Mensaje</button>
        </div>
        <div id="printCitacion" style="white-space: pre-wrap; background: white; padding: 15px; border: 1px dashed #ccc; display:none; margin-top:10px;"></div>
    </div>

    <div class="section">
        <button class="btn btn-action" onclick="exportarJSON()">üíæ Guardar Backup</button>
        <input type="file" id="fileInput" style="display:none" onchange="importarJSON(event)">
        <button class="btn btn-action" onclick="document.getElementById('fileInput').click()">üìÇ Recuperar Datos</button>
    </div>
</div>

<script>
    let db = JSON.parse(localStorage.getItem('eduManagerDB')) || { cursos: {}, activo: { curso: "", periodo: "1" } };

    function salvar() {
        localStorage.setItem('eduManagerDB', JSON.stringify(db));
        render();
    }

    function crearCurso() {
        const nom = document.getElementById('inNuevoCurso').value.trim();
        if(!nom || db.cursos[nom]) return;
        db.cursos[nom] = { 
            alumnos: [], 
            config: { "1": { ind1:[], ind2:[], ind3:[] }, "2": { ind1:[], ind2:[], ind3:[] }, "3": { ind1:[], ind2:[], ind3:[] }, "4": { ind1:[], ind2:[], ind3:[] } }
        };
        db.activo.curso = nom;
        salvar();
    }

    function eliminarCurso() {
        if(confirm(`¬øBorrar curso "${db.activo.curso}"?`)) {
            delete db.cursos[db.activo.curso];
            db.activo.curso = "";
            salvar();
        }
    }

    function a√±adirAlumno() {
        const nom = document.getElementById('inAlumno').value.trim();
        if(!nom) return;
        db.cursos[db.activo.curso].alumnos.push({ nombre: nom, notes: {} });
        salvar();
    }

    function eliminarAlumno(idx) {
        if(confirm("¬øEliminar estudiante?")) {
            db.cursos[db.activo.curso].alumnos.splice(idx, 1);
            salvar();
        }
    }

    function a√±adirActividad(nInd) {
        const t = prompt("Actividad:");
        if(t) {
            db.cursos[db.activo.curso].config[db.activo.periodo][`ind${nInd}`].push({ titulo: t });
            salvar();
        }
    }

    function eliminarActividad(nInd, actIdx) {
        if(confirm("¬øBorrar columna?")) {
            db.cursos[db.activo.curso].config[db.activo.periodo][`ind${nInd}`].splice(actIdx, 1);
            salvar();
        }
    }

    function actualizarNota(input, alumnoIdx, clave, valor) {
        const val = parseFloat(valor) || 0;
        const curso = db.activo.curso;
        const per = db.activo.periodo;

        // Si es examen, se guarda de forma especial para que sea √∫nico por periodo
        const esExamen = clave.includes("examen");
        const keyFinal = esExamen ? `${per}_examen_bimestral` : `${per}_${clave}`;

        if(!db.cursos[curso].alumnos[alumnoIdx].notes) db.cursos[curso].alumnos[alumnoIdx].notes = {};
        db.cursos[curso].alumnos[alumnoIdx].notes[keyFinal] = val;
        
        localStorage.setItem('eduManagerDB', JSON.stringify(db));

        // Actualizar visualmente todos los campos de examen de este alumno
        if(esExamen) {
            const todosLosExamenes = document.querySelectorAll(`.examen-al-${alumnoIdx}`);
            todosLosExamenes.forEach(exInput => {
                exInput.value = val;
                if(val < 75) exInput.classList.add('low');
                else exInput.classList.remove('low');
            });
        } else {
            if(val < 75) input.classList.add('low');
            else input.classList.remove('low');
        }

        // Recalcular los 3 promedios
        for(let i=1; i<=3; i++) {
            const final = calcularFinalIndicador(db.cursos[curso].alumnos[alumnoIdx], i);
            const cell = document.getElementById(`final_${alumnoIdx}_ind${i}`);
            if(cell) {
                cell.innerText = final.toFixed(1);
                if(final < 75) cell.classList.add('low-grade');
                else cell.classList.remove('low-grade');
            }
        }
        actualizarListaDificultades();
    }

    function calcularFinalIndicador(alumno, nInd) {
        const curso = db.activo.curso;
        const per = db.activo.periodo;
        const acts = db.cursos[curso].config[per][`ind${nInd}`];
        let suma = 0;
        acts.forEach((_, idx) => {
            suma += (alumno.notes[`${per}_ind${nInd}_act${idx}`] || 0);
        });
        const prom = acts.length > 0 ? (suma / acts.length) : 0;
        const exam = alumno.notes[`${per}_examen_bimestral`] || 0;
        return (prom * 0.7) + (exam * 0.3);
    }

    function render() {
        const ck = db.activo.curso;
        const per = db.activo.periodo;
        document.getElementById('txtCurso').innerText = ck ? `Curso: ${ck}` : "Seleccione un curso";
        document.getElementById('txtPeriodo').innerText = `Periodo: ${per}`;
        document.getElementById('areaAlumnos').style.display = ck ? 'flex' : 'none';
        document.getElementById('seccionAlertas').style.display = ck ? 'block' : 'none';
        document.getElementById('seccionCitaciones').style.display = ck ? 'block' : 'none';
        document.getElementById('btnEliminarCurso').style.display = ck ? 'inline-block' : 'none';

        const selC = document.getElementById('selCurso');
        selC.innerHTML = '<option value="">--- Seleccionar ---</option>';
        Object.keys(db.cursos).forEach(c => selC.innerHTML += `<option value="${c}" ${c===ck?'selected':''}>${c}</option>`);

        const main = document.getElementById('mainCalificaciones');
        main.innerHTML = "";
        if(!ck) return;

        for(let i=1; i<=3; i++) {
            const acts = db.cursos[ck].config[per][`ind${i}`];
            let h = `<div class="indicador-block"><div class="flex-row"><h3>Indicador ${i}</h3><button class="btn btn-add" onclick="a√±adirActividad(${i})">+ Actividad</button></div>
                     <div class="table-container"><table><thead><tr><th class="col-estudiante">Estudiante</th>`;
            acts.forEach((a, idx) => h += `<th><button class="btn-del-task" onclick="eliminarActividad(${i},${idx})">‚úï</button>${a.titulo}</th>`);
            h += `<th>Examen Bimestral (30%)</th><th>Final Ind ${i}</th><th>Acci√≥n</th></tr></thead><tbody>`;

            db.cursos[ck].alumnos.forEach((al, aIdx) => {
                h += `<tr><td class="col-estudiante">${al.nombre}</td>`;
                acts.forEach((_, actIdx) => {
                    const id = `ind${i}_act${actIdx}`;
                    const v = (al.notes && al.notes[`${per}_${id}`]) || 0;
                    h += `<td><input type="number" value="${v}" class="${v < 75 ? 'low' : ''}" onchange="actualizarNota(this, ${aIdx}, '${id}', this.value)"></td>`;
                });
                
                const exV = (al.notes && al.notes[`${per}_examen_bimestral`]) || 0;
                const f = calcularFinalIndicador(al, i);
                
                h += `<td><input type="number" value="${exV}" class="examen-bimestral examen-al-${aIdx} ${exV < 75 ? 'low' : ''}" onchange="actualizarNota(this, ${aIdx}, 'examen', this.value)"></td>
                      <td id="final_${aIdx}_ind${i}" class="final-cell ${f < 75 ? 'low-grade' : ''}">${f.toFixed(1)}</td>
                      <td><button class="btn-small-del" onclick="eliminarAlumno(${aIdx})">Borrar</button></td></tr>`;
            });
            main.innerHTML += h + `</tbody></table></div></div>`;
        }
        actualizarListaDificultades();
    }

    function actualizarListaDificultades() {
        const ck = db.activo.curso;
        if(!ck) return;
        const lista = document.getElementById('listaDificultades');
        const selCi = document.getElementById('selAlumnoCitacion');
        lista.innerHTML = ""; selCi.innerHTML = "";
        let count = 0;
        db.cursos[ck].alumnos.forEach(al => {
            let b = [];
            for(let i=1; i<=3; i++) if(calcularFinalIndicador(al, i) < 75) b.push(i);
            if(b.length > 0) {
                count++;
                lista.innerHTML += `<li><strong>${al.nombre}</strong> (Ind: ${b.join(", ")})</li>`;
                selCi.innerHTML += `<option value="${al.nombre}">${al.nombre}</option>`;
            }
        });
        if(count === 0) lista.innerHTML = "‚úÖ Sin alertas.";
    }

    function generarCitacion() {
        const al = document.getElementById('selAlumnoCitacion').value;
        const ac = document.getElementById('nombreAcudiente').value;
        if(!ac) { alert("Escriba el nombre del acudiente"); return; }
        const t = `Estimado(a) acudiente de ${al}:\n\nEl estudiante presenta promedio bajo (< 75) en Ingl√©s en este periodo.\n\nPor favor estar pendiente del proceso acad√©mico.`;
        const b = document.getElementById('printCitacion');
        b.innerText = t; b.style.display = "block";
    }

    function seleccionarCurso() { db.activo.curso = document.getElementById('selCurso').value; salvar(); }
    function seleccionarPeriodo() { db.activo.periodo = document.getElementById('selPeriodo').value; salvar(); }
    function exportarJSON() {
        const s = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db));
        const a = document.createElement('a'); a.href = s; a.download = "notas_ingles.json"; a.click();
    }
    function importarJSON(e) {
        const r = new FileReader(); r.onload = (ev) => { db = JSON.parse(ev.target.result); salvar(); };
        r.readAsText(e.target.files[0]);
    }
    render();
</script>
</body>
</html>